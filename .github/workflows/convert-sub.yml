name: Convert subscription to Clash provider
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch remote TXT subscription
        run: |
          SUB_URL="https://raw.githubusercontent.com/igareck/vpn-configs-for-russia/refs/heads/main/BLACK_VLESS_RUS_mobile.txt"
          curl -fsSL -o sub.txt "$SUB_URL"
          echo "Downloaded $(wc -c < sub.txt) bytes"

      - name: Try base64 decode if needed
        run: |
          if grep -qiE '^(vmess|vless|ss|trojan)' sub.txt; then
            echo "Plain links detected — no decode"
            cp sub.txt sub_clean.txt
          else
            echo "Attempting base64 decode"
            base64 -d sub.txt > sub_decoded.txt || true
            if grep -qiE '^(vmess|vless|ss|trojan)' sub_decoded.txt; then
              mv sub_decoded.txt sub_clean.txt
              echo "Decoded base64 to sub_clean.txt"
            else
              echo "Decode failed or not needed — using original"
              cp sub.txt sub_clean.txt
            fi
          fi
          wc -l sub_clean.txt || true

      - name: Run subconverter to produce Clash provider
        run: |
          docker run --rm -v $PWD:/work -w /work tindy2013/subconverter:latest \
            -i sub_clean.txt -o clash -f provider.yaml || (echo "subconverter failed" && exit 1)
          echo "provider.yaml generated, size: $(wc -c < provider.yaml) bytes"

      - name: Commit provider.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add provider.yaml || true
          git commit -m "Auto update provider $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "No changes to commit"
          git push origin HEAD:$(git rev-parse --abbrev-ref HEAD)
